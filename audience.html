<html>
	<head>
		<script src="http://cdn.peerjs.com/0.3/peer.min.js">/script>		
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">
		
			var socket = io.connect('http://128.122.151.187:8080/');
			
			socket.on('connect', function() {
				console.log("Connected");
				if (peer_id != null) {
					// We already have a peer_id so let's send it
					socket.emit('peer_id', peer_id);
				}
			});

			// Receive mouse
			socket.on('mouse', function (data) {
				//console.log(data.startX + " " + data.startY);
			});
			
			var sendmouse = function(startX, startY, endX, endY) {
				socket.emit('mouse',{ startX: startX, startY: startY, endX: endX, endY: endY });
			};

			///////////////
			
			var canvas;
			var context;
			var px = -1;
			var py = -1;
			var mousedown = false;

			var initcanvas = function() {
				canvas = document.getElementById('mycanvas');
				context = canvas.getContext('2d');
			
				context.fillStyle="#000000";
				context.fillRect(0,0,canvas.width,canvas.height);	
				
				canvas.addEventListener('mousedown', function(evt) {
					
					// Get the canvas bounding rect
					var canvasRect = canvas.getBoundingClientRect(); 

					// Now calculate the mouse position values
					py = evt.clientY - canvasRect.top; // minus the starting point of the canvas rect
					px = evt.clientX - canvasRect.left;  // minus the starting point of the canvas rect on the x axis
											
					mousedown = true;
				});
				
				canvas.addEventListener('mouseup', function(evt) {
					mousedown = false;
				});
				
				canvas.addEventListener('mousemove', function(evt) {
					
					console.log("mousemove " + evt.clientX + " " + evt.clientY);

					if (mousedown) {
					
						//evt.clientX is x but in the entire window, not the canvas
						//evt.clientY is y
		
						// Get the canvas bounding rect
						var canvasRect = canvas.getBoundingClientRect(); 

						// Now calculate the mouse position values
						y = evt.clientY - canvasRect.top; // minus the starting point of the canvas rect
						x = evt.clientX - canvasRect.left;  // minus the starting point of the canvas rect on the x axis
				
						console.log("mousemove x:" + x + " y:" + y);

						sendmouse(px, py, x, y);
						draw(px, py, x, y);
						px = x;
						py = y;
					}
				}, false);				
			};
	
			var draw = function(startX, startY, endX, endY) {
				context.beginPath();
				context.strokeStyle='#FFFFFF';
				context.moveTo(startX,startY);
				context.lineTo(endX,endY);
				context.stroke();			
			};
			
			document.addEventListener("DOMContentLoaded", initcanvas, false);
			
			/////////////
			
			// We'll use a global variable to hold on to our id from PeerJS
			var peer_id = null;

			// Register for an API Key:	http://peerjs.com/peerserver
			var peer = new Peer({key: 'uohu08l7r6swcdi'});

			// Get an ID from the PeerJS server		
			peer.on('open', function(id) {
			  console.log('My peer ID is: ' + id);
			  peer_id = id;
			  if (socket != null) {
				socket.emit('peer_id', peer_id);
			  }
			});
			
			peer.on('call', function(incoming_call) {
				console.log("Got a call!");
				incoming_call.answer(my_stream); // Answer the call with our stream from getUserMedia
				incoming_call.on('stream', function(remoteStream) {  // we receive a getUserMedia stream from the remote caller
					// And attach it to a video object
					var videoElement = document.getElementById('myvideo');
					ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
					ovideoElement.play();
				});
			});
			
		</script>
		<style>
			body {
				background-color: #000000;
			}
			
			#mycanvas {
			
			}
			
			#myvideo {
			
			}
		</style>		
	</head>
	<body>
		<canvas width="600" height="600" id="mycanvas" />
		<video id="myvideo" width="320" height="240" id="myvideo"></video>
	</body>
</html>